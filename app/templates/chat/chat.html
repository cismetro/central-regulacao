{% extends "base.html" %}
{% block title %}Chat{% endblock %}

{% block content %}
<div class="mx-auto max-w-3xl rounded-2xl border border-slate-200 bg-white shadow-sm">
  <div class="flex flex-col h-[70vh]">

    <!-- Abas -->
    <div id="chat-tabs" class="flex border-b border-slate-200 bg-slate-50">
      {% if role == 'admin' %}
        {% for conversa in conversas %}
          <button class="tab-button {% if loop.first %}active border-b-2 border-primario-600 text-primario-700{% else %}text-slate-600 hover:text-primario-700{% endif %} px-4 py-2 text-sm font-medium"
                  data-room="{{ conversa.room }}"
                  data-id="{{ conversa.id }}">
            {{ conversa.participantes }}
          </button>
        {% endfor %}
      {% else %}
        <button class="tab-button active px-4 py-2 text-sm font-medium text-primario-700 border-b-2 border-primario-600"
                data-room="{{ room_name }}"
                data-id="{{ conversation_id }}">
          Chat com Admin
        </button>
      {% endif %}
    </div>

    <!-- Mensagens -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-50"></div>

    <!-- Campo de mensagem -->
    <div class="flex items-center border-t border-slate-200 bg-white p-3">
      <input id="message-input" type="text" placeholder="Digite sua mensagem..."
             class="flex-1 rounded-xl border border-slate-300 px-4 py-2 text-sm focus:border-primario-400 focus:ring-1 focus:ring-primario-400 outline-none" />
      <button id="send-button"
              class="ml-3 rounded-xl bg-primario-600 text-white px-4 py-2 text-sm font-semibold hover:bg-primario-700">
        Enviar
      </button>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script>
  const socket = io.connect();

  let currentRoom = "{{ room_name or (conversas[0].room if conversas|length > 0 else '') }}";
  let conversationId = "{{ conversation_id or (conversas[0].id if conversas|length > 0 else 0) }}";
  const currentUser = "{{ current_user.nome }}";
  const isAdmin = "{{ role }}" === "admin";

  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendButton = document.getElementById("send-button");
  const tabs = document.querySelectorAll(".tab-button");

  async function loadMessages(conversationId) {
  console.log("ðŸ“œ Carregando mensagens da conversa:", conversationId);
  try {
    const res = await fetch(`/chat/mensagens/${conversationId}`);
    const mensagens = await res.json();

    messagesDiv.innerHTML = "";
    mensagens.forEach(msg => {
      const msgElem = document.createElement("div");
      msgElem.classList.add("px-3", "py-2", "rounded-xl", "max-w-[75%]", "text-sm", "shadow-sm");

      if (msg.user === "{{ current_user.nome }}") {
        msgElem.classList.add("bg-primario-100", "self-end", "ml-auto");
      } else {
        msgElem.classList.add("bg-white", "border", "border-slate-200");
      }

      msgElem.innerHTML = `<strong>${msg.user}:</strong> ${msg.message}`;
      messagesDiv.appendChild(msgElem);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch (e) {
    console.error("âŒ Erro ao carregar mensagens:", e);
  }
}

  function joinRoom(roomName, id) {
    console.log("ðŸ” Entrando na sala:", roomName);
    socket.emit("join", { room: roomName });
    currentRoom = roomName;
    conversationId = id;

    tabs.forEach(btn => btn.classList.remove("active", "border-b-2", "border-primario-600", "text-primario-700"));
    const activeTab = document.querySelector(`[data-room="${roomName}"]`);
    if (activeTab)
      activeTab.classList.add("active", "border-b-2", "border-primario-600", "text-primario-700");

    loadMessages(id);
  }

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      const room = btn.dataset.room;
      const id = btn.dataset.id;
      joinRoom(room, id);
    });
  });

  socket.on("connect", () => {
    console.log("âœ… Conectado ao servidor SocketIO");
    joinRoom(currentRoom, conversationId);
  });

  socket.on("message", data => {
    const messageElem = document.createElement("div");
    messageElem.classList.add("px-3", "py-2", "rounded-xl", "max-w-[75%]", "text-sm", "shadow-sm");
    if (data.user === currentUser) {
      messageElem.classList.add("bg-primario-100", "self-end", "ml-auto");
    } else {
      messageElem.classList.add("bg-white", "border", "border-slate-200");
    }
    messageElem.innerHTML = `<strong>${data.user}:</strong> ${data.msg}`;
    messagesDiv.appendChild(messageElem);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  sendButton.onclick = function() {
    if (!messageInput.value.trim()) return;
    socket.emit("send_message", { room: currentRoom, message: messageInput.value, conversation_id: conversationId });
    messageInput.value = "";
  };

  messageInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendButton.click();
  });
</script>
{% endblock %}
